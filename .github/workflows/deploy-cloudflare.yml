name: ğŸš€ Deploy cloud-mail-docs to Cloudflare Workers

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  Deploy-cloud-mail-docs:
    name: ğŸ—ï¸ Build and Deploy
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN || vars.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID || vars.CLOUDFLARE_ACCOUNT_ID }}

    steps:
      - name: ğŸšš æ£€å‡ºä»£ç ä»“åº“ / Checkout repository
        uses: actions/checkout@v4

      - name: âš™ è®¾ç½® pnpm / Set up pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: latest

      - name: âš™ è®¾ç½® Node.js / Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: "./pnpm-lock.yaml"

      - name: ğŸ“¦ å®‰è£…ä¾èµ– / Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ“¡ ç¦ç”¨ Wrangler é¥æµ‹ / Disable wrangler telemetry
        run: pnpm wrangler telemetry disable

      - name: ğŸš€ å¼€å§‹éƒ¨ç½² / Start deployment
        id: deploy
        run: |
          pnpm run docs:build && pnpm wrangler deploy | grep -v "https://.*\.workers\.dev" || true
          
          DEPLOY_EXIT_CODE=${PIPESTATUS[0]}
          if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
            exit 1
          fi

      - name: ğŸ—‘ï¸ åˆ é™¤è¿è¡Œè®°å½• / Delete workflow runs
        uses: GitRML/delete-workflow-runs@main
        continue-on-error: true
        with:
          retain_days: '1'
          keep_minimum_runs: '0'